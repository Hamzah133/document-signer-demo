<div class="designer">
  <!-- Toolbar Navbar -->
  <nav class="toolbar">
    <div class="toolbar-left">
      <button (click)="backToDashboard()" class="ghost-btn">← Back</button>
      <span class="doc-title">{{ document?.name || 'Untitled Document' }}</span>
    </div>
    <div class="toolbar-right">
      <label *ngIf="isDesignerMode && !isCompleted && !document?.pages?.length" class="file-upload-btn">
        <input type="file" (change)="onFileSelected($event)" accept=".pdf" class="file-input-hidden" />
        Upload PDF
      </label>
      <button class="outline-btn" (click)="toggleMode()" *ngIf="!isCompleted">
        {{ isDesignerMode ? 'Preview' : 'Edit' }}
      </button>
      <button *ngIf="isDesignerMode && document?.pages?.length && document?.status === 'draft'" (click)="toggleTemplate()" class="outline-btn">
        {{ document?.isTemplate ? 'Convert to Document' : 'Save as Template' }}
      </button>
      <button *ngIf="isDesignerMode && document?.pages?.length && !isCompleted && !document?.isTemplate" (click)="openSendModal()" class="primary-btn">Send for Signing</button>
      <button *ngIf="isDesignerMode && document?.pages?.length && document?.isTemplate" (click)="openTemplateSendModal()" class="primary-btn">Send</button>
      <button *ngIf="document?.pages?.length" (click)="downloadPdf()" class="outline-btn">Download</button>
      <button *ngIf="documentId && isDesignerMode" (click)="deleteDocument()" class="ghost-btn">Delete</button>
      <span *ngIf="isCompleted" class="completed-badge">Completed</span>
    </div>
  </nav>

  <!-- Main Layout -->
  <div class="designer-layout">
    <!-- Left Sidebar -->
    <aside class="sidebar" *ngIf="isDesignerMode && document?.status === 'draft' && !document?.isTemplate">
      <h3 class="sidebar-title">TOOLS</h3>
      <div class="tool-list">
        <button (click)="addField('SIGNATURE')" class="tool-item">
          <span class="tool-label">Signature</span>
        </button>
        <button (click)="addField('TEXT')" class="tool-item">
          <span class="tool-label">Text Field</span>
        </button>
        <button (click)="addField('DATE')" class="tool-item">
          <span class="tool-label">Date</span>
        </button>
        <button (click)="addField('INITIALS')" class="tool-item">
          <span class="tool-label">Initials</span>
        </button>
        <button (click)="addField('NUMBER')" class="tool-item">
          <span class="tool-label">Number</span>
        </button>
      </div>

      <h3 class="sidebar-title" style="margin-top: 30px;">RECIPIENTS</h3>
      <div class="recipient-list">
        <div *ngFor="let recipient of document?.recipients"
             class="recipient-item"
             [class.selected]="selectedRecipient?.id === recipient.id"
             (click)="selectRecipient(recipient)">
          <div class="recipient-color" [style.background-color]="recipient.color"></div>
          <div class="recipient-info">
            <div class="recipient-name">{{ recipient.name }}</div>
            <div class="recipient-email">{{ recipient.email }}</div>
          </div>
          <button class="recipient-remove" (click)="removeRecipient(recipient.id, $event)">×</button>
        </div>
        <button class="add-recipient-btn" (click)="addNewRecipient()">+ Add Recipient</button>
      </div>
    </aside>

    <!-- Canvas -->
    <main class="canvas" (scroll)="onPageScroll($event)">
      <div *ngFor="let page of document?.pages; let pageIndex = index" class="page-container">
        <img [src]="page.imageUrl" class="page-image">

        <ng-container *ngFor="let field of document?.fields">
          <div *ngIf="field.pageNumber === page.pageNumber && (isDesignerMode && document?.status === 'draft')">
            <div class="field-box"
                 cdkDrag
                 cdkDragBoundary=".page-container"
                 [cdkDragFreeDragPosition]="{x: 0, y: 0}"
                 (cdkDragEnded)="onDragEnd($event, field, page)"
                 [style.left.%]="field.x"
                 [style.top.%]="field.y"
                 [style.width.px]="field.width"
                 [style.height.px]="field.height"
                 [style.border-color]="getRecipient(field.recipientId)?.color">

              <button class="field-delete" (click)="docService.removeField(field.id)">×</button>

              <span class="field-label">{{ field.type }}</span>

              <div *ngIf="field.type === 'SIGNATURE' || field.type === 'INITIALS'"
                   class="field-resize-handle"
                   (mousedown)="startResize($event, field, page)"
                   (touchstart)="startResize($event, field, page)"></div>
            </div>
            
            <select *ngIf="!document?.isTemplate" 
                    class="field-recipient-dropdown" 
                    [(ngModel)]="field.recipientId" 
                    (change)="assignFieldToRecipient(field, field.recipientId)"
                    [style.left.%]="field.x"
                    [style.top.%]="field.y + (field.height / page.height * 100) + 1"
                    [style.width.px]="field.width">
              <option *ngFor="let r of document?.recipients" [value]="r.id">{{ r.name }}</option>
            </select>
          </div>

          <div *ngIf="field.pageNumber === page.pageNumber && (!isDesignerMode || document?.status !== 'draft') && !isCompleted" class="field-preview-box"
               [style.left.%]="field.x"
               [style.top.%]="field.y"
               [style.width.px]="field.width"
               [style.height.px]="field.height">
            <div class="field-preview-content">
              <img *ngIf="(field.type === 'SIGNATURE' || field.type === 'INITIALS') && field.value" 
                   [src]="field.value" class="signature-img" />
              <span *ngIf="!field.value" class="field-preview-label">{{ field.type }}</span>
              <span *ngIf="field.value && (field.type === 'TEXT' || field.type === 'DATE' || field.type === 'NUMBER')">{{ field.value }}</span>
            </div>
          </div>
        </ng-container>
      </div>
    </main>
  </div>
</div>

<!-- Send Modal -->
<div class="modal-overlay" *ngIf="showSendModal" (click)="closeSendModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Send Document for Signing</h2>
    <p>The following recipients will receive signing links via email:</p>
    
    <div class="recipient-list-modal">
      <div *ngFor="let recipient of document?.recipients" class="recipient-modal-item">
        <div class="recipient-color" [style.background-color]="recipient.color"></div>
        <div>
          <strong>{{ recipient.name }}</strong><br>
          <small>{{ recipient.email }}</small>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="ghost-btn" (click)="closeSendModal()" [disabled]="sendingInProgress">Cancel</button>
      <button class="primary-btn" (click)="sendViaEmail()" [disabled]="sendingInProgress">
        {{ sendingInProgress ? 'Sending...' : 'Send Emails' }}
      </button>
    </div>
  </div>
</div>

<!-- Template Send Modal -->
<div class="modal-overlay" *ngIf="showTemplateSendModal" (click)="closeTemplateSendModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Send Template to Recipients</h2>
    <p>Add recipients who will each fill out and sign this template:</p>
    
    <div class="template-recipients-list">
      <div *ngFor="let recipient of templateRecipients; let i = index" class="template-recipient-item">
        <input type="text" [(ngModel)]="recipient.name" placeholder="Name" class="input" />
        <input type="email" [(ngModel)]="recipient.email" placeholder="Email" class="input" />
        <button class="ghost-btn" (click)="removeTemplateRecipient(i)">×</button>
      </div>
    </div>
    
    <button class="outline-btn" (click)="addTemplateRecipient()" style="margin-bottom: 16px;">+ Add Recipient</button>

    <div class="modal-actions">
      <button class="ghost-btn" (click)="closeTemplateSendModal()" [disabled]="sendingInProgress">Cancel</button>
      <button class="primary-btn" (click)="sendTemplateToRecipients()" [disabled]="sendingInProgress">
        {{ sendingInProgress ? 'Sending...' : 'Send to All' }}
      </button>
    </div>
  </div>
</div>

<!-- Add Recipient Modal -->
<div class="modal-overlay" *ngIf="showAddRecipientModal" (click)="closeAddRecipientModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Add Recipient</h2>

    <div class="form-group">
      <label>Name</label>
      <input type="text" [(ngModel)]="newRecipient.name" placeholder="Enter recipient name" class="input" />
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" [(ngModel)]="newRecipient.email" placeholder="Enter recipient email" class="input" />
    </div>

    <div class="modal-actions">
      <button class="ghost-btn" (click)="closeAddRecipientModal()">Cancel</button>
      <button class="primary-btn" (click)="saveNewRecipient()">Add Recipient</button>
    </div>
  </div>
</div>

<app-signature-modal
  *ngIf="showSignatureModal"
  [fieldType]="(currentSignatureField?.type === 'INITIALS' ? 'INITIALS' : 'SIGNATURE')"
  (signatureSaved)="onSignatureSaved($event)"
  (closed)="showSignatureModal = false">
</app-signature-modal>